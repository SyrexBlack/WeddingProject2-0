---
phase: 04-external-integrations
plan: 02
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - src/components/sections/RSVPSection.tsx
  - src/app/page.tsx
autonomous: true
requirements:
  - INTER-02
  - INTER-03
  - INTER-04

must_haves:
  truths:
    - "RSVP form accepts guest name (min 2 chars), attendance status (3 options), and optional wishes"
    - "Form submits data via EmailJS and shows loading spinner during send"
    - "Successful submission replaces form with personalized thank-you message"
    - "Failed submission shows error toast and keeps form filled for retry"
    - "Repeat visitors who already submitted see thank-you message immediately (localStorage)"
    - "Re-submission allowed with confirmation prompt"
    - "If EmailJS env vars are missing, error message shows with direct contact link"
  artifacts:
    - path: "src/components/sections/RSVPSection.tsx"
      provides: "Complete RSVP form with EmailJS integration, validation, loading/success/error states"
      min_lines: 100
    - path: "src/app/page.tsx"
      provides: "Updated page with real MapSection and RSVPSection replacing placeholders"
      contains: "RSVPSection"
  key_links:
    - from: "src/components/sections/RSVPSection.tsx"
      to: "@emailjs/browser"
      via: "emailjs.send()"
      pattern: "emailjs\\.send"
    - from: "src/components/sections/RSVPSection.tsx"
      to: "@/lib/constants"
      via: "import { rsvpConfig }"
      pattern: "import.*rsvpConfig.*constants"
    - from: "src/components/sections/RSVPSection.tsx"
      to: "localStorage"
      via: "getItem/setItem for submission tracking"
      pattern: "localStorage\\.(get|set)Item"
    - from: "src/app/page.tsx"
      to: "src/components/sections/RSVPSection.tsx"
      via: "import { RSVPSection }"
      pattern: "import.*RSVPSection"
    - from: "src/app/page.tsx"
      to: "src/components/sections/MapSection.tsx"
      via: "import { MapSection }"
      pattern: "import.*MapSection"
---

<objective>
Build the complete RSVPSection component with form, validation, EmailJS email sending, loading/success/error states, localStorage tracking, and toast error notification. Then update page.tsx to replace Phase 4 placeholders with real MapSection and RSVPSection components.

Purpose: Deliver the core interactive feature of the wedding invitation — guests can confirm attendance and send wishes, with clear visual feedback at every step.
Output: Working RSVP form integrated with EmailJS, complete page assembly with all 8 sections using real components.
</objective>

<execution_context>
@C:/Users/user/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-external-integrations/04-RESEARCH.md
@.planning/phases/04-external-integrations/04-CONTEXT.md
@.planning/phases/04-external-integrations/04-01-SUMMARY.md
@src/lib/types.ts
@src/lib/constants.ts
@src/app/page.tsx
@src/components/ui/Container.tsx
@src/components/ui/SectionHeading.tsx
@src/components/ui/AnimatedSection.tsx
@src/components/ui/Card.tsx
@src/components/ui/Button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RSVPSection with form, EmailJS, and feedback states</name>
  <files>src/components/sections/RSVPSection.tsx</files>
  <action>
Create `src/components/sections/RSVPSection.tsx` as a client component (`'use client'` — uses useState, useRef, useEffect, EmailJS, localStorage).

**Imports:**
- `useState`, `useEffect`, `useCallback` from 'react'
- `emailjs` from '@emailjs/browser'
- `{ motion, AnimatePresence }` from 'framer-motion'
- `{ rsvpConfig }` from '@/lib/constants'
- `{ Container }`, `{ SectionHeading }`, `{ AnimatedSection }`, `{ Card }` from UI components
- `{ Check, Loader2, Send }` from 'lucide-react' (success checkmark, spinner, send button icon)

**Form State (useState):**
```ts
type FormStatus = 'idle' | 'loading' | 'success' | 'error';
type AttendanceOption = 'attending' | 'attending-plus-one' | 'not-attending';

const [name, setName] = useState('');
const [attendance, setAttendance] = useState<AttendanceOption>('attending');
const [wishes, setWishes] = useState('');
const [formStatus, setFormStatus] = useState<FormStatus>('idle');
const [errorMessage, setErrorMessage] = useState('');
const [alreadySubmitted, setAlreadySubmitted] = useState(false);
const [showConfirmResubmit, setShowConfirmResubmit] = useState(false);
```

**localStorage Logic (SSR-safe):**
- On mount (`useEffect`), check `localStorage.getItem('rsvp_submitted')`:
  - If `'true'`, set `alreadySubmitted = true` and `formStatus = 'success'` (show thank-you)
  - Also read saved name from `localStorage.getItem('rsvp_name')` for personalized message
- On successful submit: `localStorage.setItem('rsvp_submitted', 'true')` and `localStorage.setItem('rsvp_name', name)`
- Guard all localStorage calls with `typeof window !== 'undefined'`

**Validation:**
- Name: trim, minimum 2 characters. If invalid, show inline error below field (red text).
- Attendance: always has a value (radio buttons, default 'attending')
- Wishes: optional, no validation

**Submit Handler:**
```ts
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  
  // Validate name
  if (name.trim().length < 2) {
    // Show inline validation error
    return;
  }
  
  // Check for re-submission
  if (alreadySubmitted && !showConfirmResubmit) {
    setShowConfirmResubmit(true);
    return; // Show confirmation UI
  }
  
  setFormStatus('loading');
  setErrorMessage('');
  
  // Check env vars
  const serviceId = process.env.NEXT_PUBLIC_EMAILJS_SERVICE_ID;
  const templateId = process.env.NEXT_PUBLIC_EMAILJS_TEMPLATE_ID;
  const publicKey = process.env.NEXT_PUBLIC_EMAILJS_PUBLIC_KEY;
  
  if (!serviceId || !templateId || !publicKey) {
    setFormStatus('error');
    setErrorMessage('Сервис отправки не настроен. Пожалуйста, свяжитесь с нами напрямую.');
    return;
  }
  
  try {
    await emailjs.send(serviceId, templateId, {
      from_name: name.trim(),
      status: attendance === 'not-attending' ? 'Не смогу прийти' : attendance === 'attending-plus-one' ? 'Приду с парой (+1)' : 'Приду',
      plus_one: attendance === 'attending-plus-one' ? 'Да' : 'Нет',
      wishes: wishes.trim() || '(без пожеланий)',
    }, { publicKey });
    
    setFormStatus('success');
    localStorage.setItem('rsvp_submitted', 'true');
    localStorage.setItem('rsvp_name', name.trim());
    setAlreadySubmitted(true);
    setShowConfirmResubmit(false);
  } catch (error) {
    setFormStatus('error');
    setErrorMessage('Не удалось отправить ответ. Попробуйте ещё раз или свяжитесь с нами напрямую.');
  }
};
```

**Attendance Radio Buttons (3 options per CONTEXT.md):**
Use styled radio buttons that look like selectable cards/chips:
```tsx
const attendanceOptions: { value: AttendanceOption; label: string }[] = [
  { value: 'attending', label: 'Приду' },
  { value: 'attending-plus-one', label: 'Приду с парой (+1)' },
  { value: 'not-attending', label: 'Не смогу прийти' },
];
```
Render as a group of styled `<label>` elements with hidden `<input type="radio">`, visual highlight on selected (alexandrite border + light bg).

**Form Layout per CONTEXT.md:**
- Wrapped in `<AnimatedSection id="rsvp" className="py-16">`
- `<Container>` > `<SectionHeading>Ждём вашего ответа</SectionHeading>`
- Form inside `<Card className="mt-8 max-w-md mx-auto">` (elevated card with shadow per CONTEXT.md)
- Fields stacked vertically: Name input → Attendance radios → Wishes textarea → Submit button
- Input styling: `w-full px-4 py-3 rounded-card border border-alexandrite/30 bg-white/60 font-calmius text-chocolate focus:outline-none focus:ring-2 focus:ring-alexandrite/50 focus:border-alexandrite transition-colors`

**Submit Button per CONTEXT.md:**
- Idle: "Отправить" with Send icon
- Loading: "Отправка..." with spinning Loader2 icon, button disabled, form fields disabled
- Use Button component with variant="filled" size="large", full width: `className="w-full mt-6"`

**Success State per CONTEXT.md:**
- Replace entire form content with success message:
  ```tsx
  <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }}>
    <Check size={48} className="text-alexandrite mx-auto mb-4" />
    <p className="text-xl text-center font-calmius">
      Спасибо, {savedName || name}!
    </p>
    <p className="text-center opacity-70 mt-2">Ваш ответ принят</p>
  </motion.div>
  ```

**Error Toast per CONTEXT.md:**
- On error: show a fixed-position toast at bottom center with error message
- Auto-dismiss after 5 seconds
- Uses Framer Motion AnimatePresence for enter/exit animation
- Styled with `bg-error text-white` (error color from tailwind config)
- Form remains filled for retry (formStatus reverts to 'idle' on dismiss or after timeout)

**Re-submission Confirmation per CONTEXT.md:**
- When `alreadySubmitted` is true and user clicks submit:
  - Show inline message: "Вы уже отправляли ответ. Отправить новый?"
  - Two buttons: "Да, отправить" (proceeds with submit) / "Отмена" (resets to idle)

**Contact Fallback per CONTEXT.md:**
- When EmailJS is unavailable (env vars missing or send fails), show contact info from `rsvpConfig.contact`:
  ```tsx
  <p className="text-sm text-center mt-4 opacity-70">
    Или напишите нам: <a href={rsvpConfig.contact.telegramUrl} target="_blank" rel="noopener noreferrer" className="text-alexandrite underline">Telegram</a>
  </p>
  ```
- Show this fallback link BOTH on error state AND below the form as a subtle "Или напишите нам" link always visible.

**Export:** Named export `RSVPSection`.
  </action>
  <verify>
- File exists at `src/components/sections/RSVPSection.tsx`
- Has `'use client'` directive
- No TypeScript errors: `npx tsc --noEmit`
- Imports emailjs from '@emailjs/browser'
- Uses localStorage with SSR guard
- Has all 4 form states: idle, loading, success, error
- Has 3 attendance radio options
  </verify>
  <done>RSVPSection renders complete form with name input, 3 attendance options, wishes textarea, EmailJS integration, loading/success/error states, localStorage tracking, re-submission confirmation, and contact fallback</done>
</task>

<task type="auto">
  <name>Task 2: Update page.tsx with real MapSection and RSVPSection</name>
  <files>src/app/page.tsx</files>
  <action>
Update `src/app/page.tsx` to replace the Phase 4 placeholder sections with real components:

1. Add imports:
   ```tsx
   import { MapSection } from '@/components/sections/MapSection';
   import { RSVPSection } from '@/components/sections/RSVPSection';
   ```

2. Replace the RSVP placeholder block (the `<AnimatedSection id="rsvp">` with "RSVP-форма будет реализована в Phase 4") with:
   ```tsx
   {/* 6. RSVP — «Ждём вашего ответа» */}
   <RSVPSection />
   ```

3. Replace the Map placeholder block (the `<AnimatedSection id="map">` with "Карта будет добавлена в Phase 4") with:
   ```tsx
   {/* 7. Map — «Место проведения» */}
   <MapSection />
   ```

4. Keep the section order as-is: Hero → Countdown → Info → Timeline → Dresscode → RSVP → Map → Footer (per CONTEXT.md: RSVP before Map).

5. Remove unused imports if any (AnimatedSection and Button may no longer be needed in page.tsx if they were only used by the placeholder sections — check all usages before removing).

The page should remain a server component (no 'use client'). RSVPSection is a client component imported into a server component — this is valid in Next.js App Router.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- page.tsx imports both MapSection and RSVPSection
- No placeholder text about "Phase 4" remains in page.tsx
- Section order: Hero, Countdown, Info, Timeline, Dresscode, RSVP, Map, Footer
  </verify>
  <done>page.tsx uses real MapSection and RSVPSection components — no Phase 4 placeholders remain. All 8 sections render from dedicated section components.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with no errors
- `npx tsc --noEmit` passes
- All 8 sections in page.tsx use dedicated section components (no inline placeholders)
- RSVPSection has 'use client' and imports @emailjs/browser
- RSVPSection handles all 4 states: idle form, loading, success, error
- RSVPSection uses localStorage for submission tracking (SSR-safe)
- MapSection and RSVPSection follow existing section component patterns
- RSVP section order is before Map (per CONTEXT.md)
</verification>

<success_criteria>
- RSVP form accepts name (2+ chars), 3 attendance options, optional wishes
- Form sends data via emailjs.send() with template params
- Loading state: button shows "Отправка..." + spinner, form disabled
- Success state: form replaced with "Спасибо, [Имя]! Ваш ответ принят" + checkmark
- Error state: toast notification at bottom, form stays filled
- localStorage remembers submission — repeat visitors see success state
- Re-submission shows confirmation prompt before sending
- Missing env vars show graceful error with contact link fallback
- page.tsx has all 8 sections with real components, zero placeholders
</success_criteria>

<output>
After completion, create `.planning/phases/04-external-integrations/04-02-SUMMARY.md`
</output>
