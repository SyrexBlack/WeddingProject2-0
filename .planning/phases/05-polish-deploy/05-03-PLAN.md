---
phase: 05-polish-deploy
plan: 03
type: execute
wave: 2
depends_on:
  - 05-01
  - 05-02
files_modified:
  - next.config.ts
autonomous: false
requirements:
  - DEPLOY-04
  - DEPLOY-05

user_setup:
  - service: vercel
    why: "Hosting and deployment platform"
    env_vars:
      - name: NEXT_PUBLIC_EMAILJS_SERVICE_ID
        source: "EmailJS Dashboard -> Email Services -> Service ID"
      - name: NEXT_PUBLIC_EMAILJS_TEMPLATE_ID
        source: "EmailJS Dashboard -> Email Templates -> Template ID"
      - name: NEXT_PUBLIC_EMAILJS_PUBLIC_KEY
        source: "EmailJS Dashboard -> Account -> API Keys -> Public Key"
    dashboard_config:
      - task: "Connect GitHub repository to Vercel"
        location: "vercel.com -> New Project -> Import Git Repository -> select SyrexBlack/WeddingProject2-0"
      - task: "Set NEXT_PUBLIC_EMAILJS_* environment variables"
        location: "Vercel Dashboard -> Project -> Settings -> Environment Variables"

must_haves:
  truths:
    - "npm run build завершается без ошибок"
    - "Lighthouse Performance score > 90 на мобильном (локально или после деплоя)"
    - "Сайт доступен по публичному URL на Vercel с HTTPS"
    - "При отправке ссылки в мессенджер отображается OG-карточка (после деплоя)"
  artifacts:
    - path: "next.config.ts"
      provides: "Production-optimized Next.js configuration"
    - path: ".vercel"
      provides: "Vercel project link (created by deploy)"
  key_links:
    - from: "GitHub main branch"
      to: "Vercel deployment"
      via: "Auto-deploy on push"
      pattern: "vercel.app"
---

<objective>
Verify production build, optimize for Lighthouse Performance > 90, and deploy to Vercel.

Purpose: Make the wedding invitation accessible via public HTTPS URL (DEPLOY-04) with Lighthouse Performance > 90 (DEPLOY-05).
Output: Production build passing, performance optimizations applied, site live on Vercel.
</objective>

<execution_context>
@C:/Users/user/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/user/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/05-polish-deploy/05-01-SUMMARY.md
@.planning/phases/05-polish-deploy/05-02-SUMMARY.md

@next.config.ts
@src/app/layout.tsx
@src/app/page.tsx
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Production build verification and Lighthouse optimizations</name>
  <files>next.config.ts</files>
  <action>
**1. Run production build:**
- Execute `npm run build` and capture output
- Fix any TypeScript errors, ESLint warnings, or build failures
- Note the build output: page sizes, static/dynamic pages, image optimization status

**2. Optimize `next.config.ts` for performance:**
- Enable `poweredByHeader: false` — removes X-Powered-By header (security + minor perf)
- Enable `compress: true` — gzip compression (Vercel does this by default, but good for local)
- No need for `output: 'standalone'` — Vercel handles deployment natively
- No `images.remotePatterns` needed — all images are local in `public/`

**3. Lighthouse performance considerations (pre-deploy checklist):**
Common issues to check and fix:
- **Font preloading:** Cormorant Garamond loads via next/font/google which handles preloading automatically. Verify no FOUT.
- **Hero image priority:** Verify `priority` prop is on hero images (should be from 05-01). This sets `fetchpriority="high"` and disables lazy loading for LCP element.
- **Unused JavaScript:** framer-motion is heavy (~50KB). But it's needed for animations. Ensure tree-shaking works (import specific components, not entire library — already done in codebase).
- **CSS:** Tailwind v4 purges unused CSS automatically in production build.
- **Body font-size:** Currently 18px in globals.css — this is fine, not a Lighthouse issue.
- **Iframe loading:** MapSection's Yandex Maps iframe should have `loading="lazy"` attribute to defer loading until user scrolls to it. If not present, add it in the iframe element. (This is a cross-file optimization — note for MapSection if not already done in 05-02).

**4. Check for common build warnings:**
- Missing `alt` attributes on images
- Console errors in production mode
- Unused imports
- Any Next.js deprecation warnings

If MapSection iframe doesn't have `loading="lazy"`, create a note in summary for the executor to add it when touching MapSection files (or add it directly if MapSection wasn't locked by 05-02).
  </action>
  <verify>
`npm run build` completes successfully with zero errors. Build output shows reasonable page sizes (< 200KB first load JS). Run `npx next start` and use Lighthouse CLI: `npx lighthouse http://localhost:3000 --preset=perf --output=json --chrome-flags="--headless"` — Performance score should be > 90. If Lighthouse CLI is not available, note the build sizes and confirm they're reasonable.
  </verify>
  <done>
Production build passes with zero errors. next.config.ts has production optimizations. Build output shows reasonable bundle sizes. Performance optimizations applied (image priority, lazy iframe, font preload).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Deploy to Vercel and verify public URL</name>
  <files>none (deployment)</files>
  <action>
Claude will attempt to deploy via `npx vercel --yes` CLI. If Vercel CLI authentication is needed, the user will complete the auth flow.

**Alternative (recommended per user decision):** Connect GitHub repository in Vercel Dashboard:
1. Go to https://vercel.com/new
2. Import: https://github.com/SyrexBlack/WeddingProject2-0
3. Framework Preset: Next.js (auto-detected)
4. Add Environment Variables:
   - `NEXT_PUBLIC_EMAILJS_SERVICE_ID` = your EmailJS service ID
   - `NEXT_PUBLIC_EMAILJS_TEMPLATE_ID` = your EmailJS template ID
   - `NEXT_PUBLIC_EMAILJS_PUBLIC_KEY` = your EmailJS public key
5. Click Deploy

After deployment, all future pushes to `main` will auto-deploy.

**What was built:**
Complete wedding invitation site with all 8 sections (Hero with photos, Countdown, Info, Timeline, Dresscode, RSVP, Map, Footer), dynamic OG image generation for messenger previews, mobile-optimized layout (320px+), production build passing with optimizations.
  </action>
  <verify>
1. Open the Vercel deployment URL (e.g., `https://wedding-project2-0.vercel.app`) — site loads with HTTPS
2. Scroll through all 8 sections — everything renders correctly
3. Open DevTools → Lighthouse → run Mobile Performance audit → score should be > 90
4. Copy the deployment URL and paste into Telegram — verify OG card appears with gradient image, title "Анна & Михаил — Приглашение на свадьбу", description with date and venue
5. (Optional) Paste URL in WhatsApp — same OG card should appear
6. Test RSVP form submission (if EmailJS env vars configured)
7. Verify map iframe loads and "Построить маршрут" button works
  </verify>
  <done>
Site is live on Vercel with HTTPS. OG card displays correctly in Telegram. Lighthouse Performance > 90 on mobile. All sections functional. User confirms "approved" with the Vercel URL.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. Site is live on Vercel with HTTPS
3. OG card displays correctly in Telegram/WhatsApp
4. Lighthouse Performance > 90 on mobile
5. All sections render correctly on deployed site
</verification>

<success_criteria>
- Production build passes with zero errors
- Site accessible via public Vercel URL with HTTPS
- Lighthouse Performance score > 90 on mobile
- OG card with gradient image renders in messenger previews
- All 8 sections functional on deployed site
</success_criteria>

<output>
After completion, create `.planning/phases/05-polish-deploy/05-03-SUMMARY.md`
</output>
